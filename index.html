<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionale Parrucchiere</title>
    <link rel="icon" href="data:,">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Icone -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .client-card { 
            cursor: pointer; transition: all 0.2s; border: none; border-left: 5px solid #0d6efd;
        }
        .client-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .history-timeline { border-left: 2px solid #e9ecef; padding-left: 20px; margin-left: 10px; }
        .history-item { margin-bottom: 25px; position: relative; }
        .history-item::before {
            content: ''; position: absolute; left: -26px; top: 5px;
            width: 12px; height: 12px; background: #0d6efd; border-radius: 50%; border: 2px solid #fff;
        }
        .badge-type { background-color: #e7f1ff; color: #0d6efd; border: 1px solid #cff4fc; }
        .badge-oxi { background-color: #f8f9fa; color: #6c757d; border: 1px solid #dee2e6; }
        .modal-header { background-color: #0d6efd; color: white; }
        .btn-close { filter: invert(1); }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="navbar navbar-dark bg-primary mb-4 shadow">
        <div class="container">
            <span class="navbar-brand mb-0 h1"><i class="bi bi-scissors"></i> Color Manager</span>
            
            <div class="d-flex gap-2">
                <!-- Menu Avanzate -->
                <div class="dropdown">
                    <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="bi bi-gear"></i> Dati
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" id="btnExportData"><i class="bi bi-download"></i> Backup (Download)</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#importModal"><i class="bi bi-upload"></i> Importa da Excel/JSON</a></li>
                    </ul>
                </div>
                
                <!-- Pulsante Nuovo -->
                <button class="btn btn-light text-primary fw-bold shadow-sm" data-bs-toggle="modal" data-bs-target="#newClientModal">
                    <i class="bi bi-plus-lg"></i> Nuovo Cliente
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <!-- Cerca -->
        <div class="row mb-4 justify-content-center">
            <div class="col-md-8">
                <div class="input-group input-group-lg shadow-sm">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                    <input type="text" id="searchInput" class="form-control border-start-0" placeholder="Cerca cliente (nome, cognome o ID vecchio)...">
                </div>
            </div>
        </div>

        <!-- Lista Clienti -->
        <div id="clientsList" class="row g-3">
            <div class="text-center mt-5"><div class="spinner-border text-primary"></div><p class="mt-2 text-muted">Caricamento database...</p></div>
        </div>
    </div>

    <!-- MODAL: Dettaglio Cliente & Storico -->
    <div class="modal fade" id="clientModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <div>
                        <h5 class="modal-title fw-bold" id="modalClientName">Scheda Cliente</h5>
                        <small id="modalOldId" class="text-white-50" style="font-size: 0.8rem;"></small>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light">
                    
                    <!-- Form per Nuova Colorazione -->
                    <div class="card mb-4 border-0 shadow-sm">
                        <div class="card-body">
                            <h6 class="card-title text-primary mb-3"><i class="bi bi-plus-circle"></i> Aggiungi Lavoro Oggi</h6>
                            <div class="row g-2">
                                <div class="col-md-3"><label class="small fw-bold text-muted">Data</label><input type="date" id="addWorkDate" class="form-control"></div>
                                <div class="col-md-3"><label class="small fw-bold text-muted">Tipo</label><input type="text" id="addWorkType" class="form-control" placeholder="Es: Colore"></div>
                                <div class="col-md-3"><label class="small fw-bold text-muted">Nuance</label><input type="text" id="addWorkNuance" class="form-control" placeholder="Es: 6.0"></div>
                                <div class="col-md-3"><label class="small fw-bold text-muted">Ossidante</label><input type="text" id="addWorkOxi" class="form-control" placeholder="Es: 20 vol"></div>
                                <div class="col-12"><label class="small fw-bold text-muted">Note</label><input type="text" id="addWorkNotes" class="form-control" placeholder="Note..."></div>
                                <div class="col-12 mt-3"><button id="btnSaveExistingWork" class="btn btn-primary w-100">Salva nel Dettaglio</button></div>
                            </div>
                        </div>
                    </div>

                    <!-- Header Storico con pulsante Pulizia -->
                    <div class="d-flex justify-content-between align-items-center mb-3 ps-2 border-start border-4 border-primary">
                        <h6 class="mb-0 fw-bold">Storico Trattamenti</h6>
                        <button id="btnPruneHistory" class="btn btn-outline-danger btn-sm py-0" style="font-size: 0.75rem;" title="Elimina i vecchi, tieni solo i 5 più recenti">
                            <i class="bi bi-trash"></i> Tieni solo ultimi 5
                        </button>
                    </div>
                    
                    <div id="historyList" class="history-timeline bg-white p-3 rounded shadow-sm"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Nuovo Cliente -->
    <div class="modal fade" id="newClientModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nuovo inserimento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-2">
                        <div class="col-6"><label class="small fw-bold">Nome</label><input type="text" id="newClientName" class="form-control"></div>
                        <div class="col-6"><label class="small fw-bold">Cognome</label><input type="text" id="newClientSurname" class="form-control"></div>
                        <hr class="my-3 text-muted">
                        <div class="col-12 mb-2"><label class="small fw-bold">Data</label><input type="date" id="newClientDate" class="form-control"></div>
                        <div class="col-4"><label class="small fw-bold">Tipo</label><input type="text" id="newClientType" class="form-control" placeholder="Tinta"></div>
                        <div class="col-4"><label class="small fw-bold">Nuance</label><input type="text" id="newClientNuance" class="form-control" placeholder="7.1"></div>
                        <div class="col-4"><label class="small fw-bold">Ossidante</label><input type="text" id="newClientOxi" class="form-control" placeholder="20vol"></div>
                        <div class="col-12 mt-2"><label class="small fw-bold">Note</label><textarea id="newClientNotes" class="form-control" rows="2"></textarea></div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-success px-4" id="btnSaveNewClient">Salva Tutto</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: IMPORT JSON -->
    <div class="modal fade" id="importModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title fw-bold"><i class="bi bi-database-up"></i> Importa Dati da Excel/JSON</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small">1. Prepara il tuo Excel con queste colonne esatte: <br>
                    <code>nome</code>, <code>cognome</code>, <code>old_id</code> (facoltativo), <code>ultima_formula</code> (facoltativo).<br>
                    2. Vai su un convertitore (es. csvjson.com) e converti l'Excel in JSON.<br>
                    3. Incolla il risultato qui sotto.</p>
                    <textarea id="jsonImportInput" class="form-control font-monospace small" rows="10" placeholder='[{"nome":"Maria", "cognome":"Rossi", "old_id":104}, ...]'></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="btnRunImport">Avvia Importazione</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        // Importo anche getDoc per leggere il singolo cliente
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, getDoc, updateDoc, arrayUnion, onSnapshot, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const $ = window.jQuery; 
        const firebaseConfig = {
            apiKey: "AIzaSyA3c5MmceX4gnd1IoZS-pEwSwKEhs-TaKU",
            authDomain: "mabo-75945.firebaseapp.com",
            projectId: "mabo-75945",
            storageBucket: "mabo-75945.firebasestorage.app",
            messagingSenderId: "296320402452",
            appId: "1:296320402452:web:d959d63cbfa51f46f05301"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let currentClientId = null;

        const today = new Date().toISOString().split('T')[0];
        $('#newClientDate').val(today);
        $('#addWorkDate').val(today);

        // LETTURA DATI
        const q = query(collection(db, "clients"), orderBy("lastVisitDate", "desc"));
        onSnapshot(q, (snapshot) => {
            $('#clientsList').empty();
            let count = 0;
            snapshot.forEach((doc) => {
                const client = doc.data();
                client.id = doc.id; 
                renderClientCard(client);
                count++;
            });
            if(count === 0) $('#clientsList').html('<div class="col-12 text-center text-muted py-5"><i class="bi bi-inbox fs-1"></i><p>Database vuoto.</p></div>');
        });

        function renderClientCard(client) {
            const lastColor = client.lastColoration || "Nessun dato";
            let formattedDate = "";
            if(client.lastVisitDate) {
                const parts = client.lastVisitDate.split('-');
                formattedDate = `${parts[2]}/${parts[1]}/${parts[0]}`;
            }
            const searchString = `${client.firstName} ${client.lastName} ${client.old_id || ''}`;
            
            const html = `
                <div class="col-md-4 col-sm-6 item-client" data-search="${searchString}">
                    <div class="card client-card h-100 shadow-sm bg-white" id="client-${client.id}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title fw-bold mb-0 text-dark">${client.firstName} ${client.lastName}</h5>
                                <span class="badge bg-light text-secondary border">${formattedDate}</span>
                            </div>
                            <p class="card-text text-muted small mb-1 text-uppercase fw-bold" style="font-size: 0.7rem;">Ultimo lavoro:</p>
                            <p class="card-text text-primary text-truncate">${lastColor}</p>
                            ${client.old_id ? `<small class="text-muted" style="font-size:0.6rem">ID Access: ${client.old_id}</small>` : ''}
                        </div>
                    </div>
                </div>
            `;
            $('#clientsList').append(html);
            $(`#client-${client.id}`).on('click', () => openClientDetails(client));
        }

        function openClientDetails(client) {
            currentClientId = client.id;
            $('#modalClientName').text(`${client.firstName} ${client.lastName}`);
            $('#modalOldId').text(client.old_id ? `ID Storico: ${client.old_id}` : '');
            
            $('#addWorkType').val(''); $('#addWorkNuance').val(''); $('#addWorkOxi').val('');
            $('#addWorkNotes').val(''); $('#addWorkDate').val(new Date().toISOString().split('T')[0]);
            
            renderHistory(client.history || []);
            new bootstrap.Modal(document.getElementById('clientModal')).show();
        }

        function renderHistory(historyArray) {
            $('#historyList').empty();
            // ORDINAMENTO PER DATA DECRESCENTE (Più recente in alto)
            const sortedHistory = historyArray.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Gestione visibilità pulsante "Tieni solo ultimi 5"
            if(sortedHistory.length > 5) {
                $('#btnPruneHistory').show();
            } else {
                $('#btnPruneHistory').hide();
            }

            if(sortedHistory.length === 0) {
                $('#historyList').html('<p class="text-muted fst-italic">Nessuno storico disponibile.</p>');
                return;
            }
            sortedHistory.forEach(item => {
                const dateParts = item.date ? item.date.split('-') : ['','',''];
                const niceDate = item.date ? `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}` : 'N/D';
                const displayType = item.type || '';
                const displayNuance = item.nuance || '';
                const displayOxi = item.oxidant || '';
                const legacyFormula = item.formula && !item.type && !item.nuance ? item.formula : '';

                const html = `
                    <div class="history-item">
                        <div class="fw-bold text-dark mb-1">${niceDate}</div>
                        <div class="p-3 bg-light rounded border">
                            <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
                                ${displayType ? `<span class="badge badge-type text-uppercase">${displayType}</span>` : ''}
                                ${displayNuance ? `<span class="fw-bold fs-5 text-dark">${displayNuance}</span>` : ''}
                                ${displayOxi ? `<span class="badge badge-oxi">${displayOxi}</span>` : ''}
                                ${legacyFormula ? `<span class="fw-bold text-dark">${legacyFormula}</span>` : ''}
                            </div>
                            ${item.notes ? `<div class="text-secondary small border-top pt-2 mt-2"><i class="bi bi-pencil"></i> ${item.notes}</div>` : ''}
                        </div>
                    </div>
                `;
                $('#historyList').append(html);
            });
        }

        $('#searchInput').on('keyup', function() {
            const val = $(this).val().toLowerCase();
            $('.item-client').filter(function() {
                $(this).toggle($(this).attr('data-search').toLowerCase().indexOf(val) > -1)
            });
        });

        // -----------------------
        // LOGICA PULIZIA STORICO
        // -----------------------
        document.getElementById('btnPruneHistory').addEventListener('click', async () => {
            if(!currentClientId) return;
            
            // 1. Rileggiamo il cliente dal DB per sicurezza (per avere l'array aggiornato)
            const clientRef = doc(db, "clients", currentClientId);
            const docSnap = await getDoc(clientRef);
            
            if (docSnap.exists()) {
                const clientData = docSnap.data();
                let history = clientData.history || [];
                
                if(history.length <= 5) {
                    alert("Non ci sono abbastanza dati da eliminare.");
                    return;
                }

                if(confirm(`Attenzione! Stai per eliminare ${history.length - 5} lavori vecchi dallo storico.\nRimarranno solo i 5 più recenti.\n\nSei sicuro?`)) {
                    // 2. Ordina per data (più recente primo)
                    history.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    // 3. Tieni solo i primi 5
                    const newHistory = history.slice(0, 5);

                    // 4. Salva
                    await updateDoc(clientRef, { history: newHistory });
                    
                    // 5. Aggiorna la vista nel modale subito
                    renderHistory(newHistory);
                    alert("Pulizia completata!");
                }
            }
        });

        // -----------------------
        // LOGICA DI IMPORTAZIONE
        // -----------------------
        document.getElementById('btnRunImport').addEventListener('click', async () => {
            const jsonText = $('#jsonImportInput').val();
            if(!jsonText) { alert("Incolla prima il JSON!"); return; }
            try {
                const data = JSON.parse(jsonText);
                if(!Array.isArray(data)) throw new Error("Il formato deve essere una lista [...]");
                const btn = $('#btnRunImport');
                btn.prop('disabled', true).text(`Importazione...`);
                let count = 0;
                for(let item of data) {
                    const firstName = item.nome || item.Nome || item.firstName || "Sconosciuto";
                    const lastName = item.cognome || item.Cognome || item.lastName || "";
                    const oldId = item.old_id || item.ID || item.Id || null;
                    const lastFormula = item.ultima_formula || item.UltimaFormula || "Importato da Access";
                    await addDoc(collection(db, "clients"), {
                        firstName: firstName, lastName: lastName, old_id: oldId,
                        lastColoration: lastFormula, lastVisitDate: new Date().toISOString().split('T')[0],
                        history: [{ date: new Date().toISOString().split('T')[0], formula: lastFormula, notes: "Dato importato" }]
                    });
                    count++;
                }
                alert(`Finito! Importati ${count} clienti.`);
                bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();
                $('#jsonImportInput').val('');
            } catch(e) { alert("Errore JSON: " + e.message); } finally { $('#btnRunImport').prop('disabled', false).text('Avvia Importazione'); }
        });

        // EXPORT
        document.getElementById('btnExportData').addEventListener('click', async () => {
            if(!confirm("Download Backup?")) return;
            const qExport = query(collection(db, "clients"));
            const querySnapshot = await getDocs(qExport);
            let exportData = [];
            querySnapshot.forEach((doc) => exportData.push({ id: doc.id, ...doc.data() }));
            const url = URL.createObjectURL(new Blob([JSON.stringify(exportData, null, 2)], { type: "application/json" }));
            const a = document.createElement('a');
            a.href = url; a.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        });

        // SALVATAGGI
        document.getElementById('btnSaveNewClient').addEventListener('click', async () => {
            const name = $('#newClientName').val().trim();
            const surname = $('#newClientSurname').val().trim();
            const date = $('#newClientDate').val();
            const type = $('#newClientType').val().trim();
            const nuance = $('#newClientNuance').val().trim();
            const oxi = $('#newClientOxi').val().trim();
            const notes = $('#newClientNotes').val().trim();
            if(!name || !surname) return alert("Nome mancante");
            const combined = `${type} ${nuance} ${oxi}`.trim();
            await addDoc(collection(db, "clients"), {
                firstName: name, lastName: surname,
                lastColoration: combined || "Nuovo", lastVisitDate: date,
                history: [{ date, type, nuance, oxidant: oxi, notes, formula: combined }]
            });
            bootstrap.Modal.getInstance(document.getElementById('newClientModal')).hide();
            $('#newClientName').val(''); $('#newClientSurname').val('');
        });

        document.getElementById('btnSaveExistingWork').addEventListener('click', async () => {
            if(!currentClientId) return;
            const date = $('#addWorkDate').val();
            const type = $('#addWorkType').val().trim();
            const nuance = $('#addWorkNuance').val().trim();
            const oxi = $('#addWorkOxi').val().trim();
            const notes = $('#addWorkNotes').val().trim();
            const combined = `${type} ${nuance} ${oxi}`.trim();
            await updateDoc(doc(db, "clients", currentClientId), {
                lastColoration: combined, lastVisitDate: date,
                history: arrayUnion({ date, type, nuance, oxidant: oxi, notes, formula: combined })
            });
            bootstrap.Modal.getInstance(document.getElementById('clientModal')).hide();
        });
    </script>
</body>
</html>